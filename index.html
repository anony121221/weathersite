<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cole's Weather Site</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1720;
      --muted:#9aa5b1;
      --accent:#1ea7fd;
      --text:#e6eef6;
      --gap:12px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),#061018);
      color:var(--text);
      padding:18px;
    }
    .center {text-align:center;margin-top:80px;}
    .btn {
      display:inline-block;
      padding:14px 22px;
      margin:12px;
      border-radius:12px;
      background:var(--accent);
      color:#000;
      font-size:1.1rem;
      font-weight:600;
      text-decoration:none;
      cursor:pointer;
      border:none;
    }
    .btn:hover {opacity:0.9;}
    .btn.disabled {opacity:0.5;pointer-events:none;cursor:not-allowed;}
    .page {display:none;}
    .page.active {display:block;}
    .back-btn {background:#555;color:#fff;margin-bottom:20px;}
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center}
    #search{
      padding:8px 10px;
      border-radius:8px;
      border:none;
      min-width:220px;
      background:#0b1116;
      color:var(--text);
      outline:2px solid transparent;
    }
    #search:focus{outline:2px solid rgba(30,167,253,0.12)}
    #refresh{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:linear-gradient(180deg,#0f1722,#081018);
      color:var(--text);
      cursor:pointer;
    }
    .info{color:var(--muted);font-size:0.9rem;margin-top:6px;width:100%}
    main{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .file-table{width:100%;border-collapse:collapse}
    .file-table thead th{
      text-align:left;padding:10px 8px;color:var(--muted);font-size:0.9rem;border-bottom:1px solid rgba(255,255,255,0.04)
    }
    .file-table tbody td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle}
    .small{font-size:0.85rem;color:var(--muted)}
    .btn-download{
      padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#03101a;text-decoration:none;font-weight:600
    }
    .pager{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .pager button{padding:6px 10px;border-radius:8px;border:none;background:#0b1116;color:var(--text);cursor:pointer}
    footer{margin-top:12px;color:var(--muted);font-size:0.9rem}
    @media (max-width:720px){
      .file-table thead{display:none}
      .file-table tbody td{display:block;padding:10px 6px}
      .file-table tbody tr{margin-bottom:8px;background:rgba(255,255,255,0.01);border-radius:8px}
    }
  </style>
</head>
<body>
  <div id="home" class="page active">
    <div class="center">
      <h1 style="font-size:2.2rem;margin-bottom:20px;">Cole's Weather Site</h1>
      <button class="btn" onclick="goToPage('tornado')">Tornado NEXRAD Files</button>
      <button class="btn disabled">Doppler Radar Files (Coming Soon)</button>
    </div>
  </div>

  <div id="tornado" class="page">
    <button class="btn back-btn" onclick="goToPage('home')">← Back Home</button>
    <header>
      <h1>Drive Folder Index</h1>
      <div class="controls">
        <input id="search" placeholder="Search files..." />
        <button id="refresh">Refresh</button>
      </div>
      <div id="info" class="info">Loading…</div>
    </header>

    <main>
      <table id="fileTable" class="file-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Size</th>
            <th>Modified</th>
            <th>Type</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pager" class="pager"></div>
    </main>

    <footer>
      <small>Hosted listing for folder: <span id="folderId"></span></small>
    </footer>
  </div>

<script>
const API_KEY = "AIzaSyC431oUvXQR4tv7d8ZWfUZH3eQuR0rLLcM";
const FOLDER_ID = "1Xts9_L-N68visoeqmUgN1grSqQBpsL1M";

function goToPage(pageName) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageName).classList.add('active');
  window.scrollTo(0, 0);
  if (pageName === 'tornado' && allFiles.length === 0) {
    fetchAllFiles();
  }
}

const infoEl = document.getElementById("info");
const tbody = document.querySelector("#fileTable tbody");
const folderIdEl = document.getElementById("folderId");
const refreshBtn = document.getElementById("refresh");
const searchInput = document.getElementById("search");
const pagerEl = document.getElementById("pager");

folderIdEl.textContent = FOLDER_ID;

let allFiles = [];
let pageSize = 50;
let currentPage = 1;

searchInput.addEventListener("input", renderCurrentPage);
refreshBtn.addEventListener("click", () => { fetchAllFiles(true); });

function buildListUrl(pageToken) {
  const fields = encodeURIComponent("nextPageToken, files(id,name,size,modifiedTime,mimeType)");
  const q = encodeURIComponent(`'${FOLDER_ID}' in parents and trashed=false`);
  const base = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&pageSize=1000&key=${API_KEY}`;
  return pageToken ? base + `&pageToken=${pageToken}` : base;
}

async function fetchAllFiles(force=false) {
  infoEl.textContent = "Fetching file list from Drive…";
  tbody.innerHTML = "";
  allFiles = [];
  currentPage = 1;
  pagerEl.innerHTML = "";
  try {
    let pageToken = null;
    do {
      const url = buildListUrl(pageToken);
      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Drive API error: ${res.status} ${text}`);
      }
      const data = await res.json();
      if (data.files && data.files.length) {
        allFiles.push(...data.files);
      }
      pageToken = data.nextPageToken || null;
    } while (pageToken);

    allFiles.sort((a,b) => (b.modifiedTime||"") .localeCompare(a.modifiedTime||""));

    infoEl.textContent = `Found ${allFiles.length} file(s).`;
    renderPager();
    renderCurrentPage();
  } catch (err) {
    console.error(err);
    infoEl.textContent = `Error: ${err.message}`;
  }
}

function humanSize(bytes){
  if (!bytes) return "-";
  let b = Number(bytes);
  const units = ["B","KB","MB","GB","TB"];
  let i=0;
  while (b>=1024 && i<units.length-1){ b/=1024; i++;}
  return `${b.toFixed(b>=100?0:1)} ${units[i]}`;
}

function downloadLinkFor(fileId){
  return `https://drive.google.com/uc?export=download&id=${fileId}`;
}

function renderCurrentPage(){
  const q = (searchInput.value || "").toLowerCase().trim();
  let filtered = allFiles.filter(f => {
    if (!q) return true;
    return (f.name && f.name.toLowerCase().includes(q)) ||
           (f.id && f.id.toLowerCase().includes(q));
  });
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > pages) currentPage = pages;
  const start = (currentPage - 1) * pageSize;
  const slice = filtered.slice(start, start + pageSize);

  tbody.innerHTML = "";
  if (slice.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="small">No files found.</td></tr>`;
  } else {
    for (const f of slice) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>
          <div><strong>${escapeHtml(f.name)}</strong></div>
          <div class=small>ID: ${f.id}</div>
        </td>
        <td class=small>${humanSize(f.size)}</td>
        <td class=small>${f.modifiedTime ? new Date(f.modifiedTime).toLocaleString() : "-"}</td>
        <td class=small>${f.mimeType || "-"}</td>
        <td>
          <a class="btn-download" href="${downloadLinkFor(f.id)}" target="_blank" rel="noopener noreferrer">Download</a>
        </td>
      `;
      tbody.appendChild(row);
    }
  }
  renderPager();
}

function renderPager(){
  const q = (searchInput.value||"").toLowerCase().trim();
  let filtered = allFiles.filter(f => !q || f.name.toLowerCase().includes(q));
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / pageSize));
  pagerEl.innerHTML = "";
  for (let p=1; p<=pages; p++){
    const btn = document.createElement("button");
    btn.textContent = p;
    if (p===currentPage){ btn.style.opacity = "0.6"; }
    btn.onclick = () => { currentPage=p; renderCurrentPage(); };
    pagerEl.appendChild(btn);
  }
}

function escapeHtml(t){
  return t.replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
</script>
</body>
</html>
